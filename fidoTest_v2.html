<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <!-- Google tag (gtag.js) -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-N9CD46JM8Q"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'G-N9CD46JM8Q');
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FIDO Key é‹ä½œç‹€æ…‹æ¸¬è©¦</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: #f4f4f4;
            margin: 0;
            padding: 20px;
            color: #333;
        }
        .container {
            background-color: #fff;
            padding: 30px;
            border-radius: 12px; /* åœ“è§’æ›´æ˜é¡¯ */
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15); /* é™°å½±æ›´æ·± */
            text-align: center;
            width: 100%;
            max-width: 650px; /* ç¨å¾®å¯¬ä¸€é» */
            margin-bottom: 20px;
        }
        h1 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 2em;
        }
        p {
            color: #555;
            line-height: 1.7;
            margin-bottom: 10px;
        }
        strong {
            color: #34495e;
        }
        button {
            background-color: #28a745; /* ç¶ è‰²æŒ‰éˆ• */
            color: white;
            padding: 14px 30px; /* ç¨å¤§ä¸€é» */
            border: none;
            border-radius: 8px; /* åœ“è§’æ›´æ˜é¡¯ */
            cursor: pointer;
            font-size: 1.1em;
            font-weight: bold;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 25px;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        button:hover {
            background-color: #218838;
            transform: translateY(-2px);
        }
        button:active {
            transform: translateY(0);
        }
        button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
            box-shadow: none;
        }
        .result-area {
            margin-top: 25px;
            padding: 20px;
            background-color: #ecf0f1; /* æ·ºç°è‰²èƒŒæ™¯ */
            border-radius: 10px;
            text-align: left;
            word-break: break-all;
            font-size: 0.9em;
            min-height: 120px; /* ç¢ºä¿æœ‰è¶³å¤ é«˜åº¦ */
            width: 100%;
            box-sizing: border-box;
            border: 1px solid #bdc3c7;
        }
        .result-area h3 {
            color: #34495e;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        .result-area pre {
            white-space: pre-wrap;
            word-wrap: break-word;
            padding: 5px;
            background-color: #fdfdfd;
            border-radius: 5px;
            border: 1px dashed #dcdcdc;
            max-height: 300px; /* é™åˆ¶é«˜åº¦ï¼Œå¯æ»¾å‹• */
            overflow-y: auto;
        }
        .message-area {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            font-weight: bold;
            text-align: left;
            border-left: 5px solid;
            line-height: 1.5;
        }
        .success-message {
            background-color: #e6ffe6;
            color: #1a6d3b;
            border-color: #28a745;
        }
        .error-message {
            background-color: #ffe6e6;
            color: #cc0000;
            border-color: #dc3545;
        }
        .info-message {
            background-color: #e6f7ff;
            color: #0066cc;
            border-color: #007bff;
        }
        .aaguid-info {
            font-size: 0.85em;
            color: #666;
            margin-top: 10px;
            background-color: #f8f8f8;
            padding: 10px;
            border-radius: 5px;
            border: 1px dotted #ccc;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>FIDO Key é‹ä½œç‹€æ…‹æ¸¬è©¦</h1>
        <p>
            é»æ“Šä¸‹æ–¹æŒ‰éˆ•ï¼Œç€è¦½å™¨å°‡å˜—è©¦èˆ‡æ‚¨çš„ <strong>FIDO Key</strong> æˆ–è£ç½®å…§å»ºçš„ <strong>WebAuthn é©—è­‰å™¨</strong>äº’å‹•ï¼Œ
            æ¨¡æ“¬è¨»å†Šä¸€å€‹æ†‘è­‰ã€‚å¦‚æœæ‚¨çš„ FIDO Key æ­£å¸¸ï¼Œæ‚¨æœƒæ”¶åˆ°ç€è¦½å™¨çš„æç¤ºï¼Œ
            å®Œæˆäº’å‹•å¾Œï¼Œç›¸é—œæ•¸æ“šå°‡æœƒé¡¯ç¤ºåœ¨ä¸‹æ–¹ã€‚
        </p>
        <p>
            <strong>æ³¨æ„ï¼š</strong>æ­¤æ“ä½œä¸æœƒå°‡ä»»ä½•æ†‘è­‰å„²å­˜åœ¨ä»»ä½•åœ°æ–¹ï¼Œ
            åƒ…ç”¨æ–¼æ¸¬è©¦æ‚¨çš„ FIDO Key æ˜¯å¦èƒ½æ­£å¸¸éŸ¿æ‡‰ WebAuthn è«‹æ±‚ã€‚
        </p>
        <button id="testButton">æ¸¬è©¦æˆ‘çš„ FIDO Key</button>

        <div id="messageArea" class="message-area info-message">
            è«‹é»æ“Šã€Œæ¸¬è©¦æˆ‘çš„ FIDO Keyã€æŒ‰éˆ•é–‹å§‹ã€‚
        </div>

        <div class="result-area">
            <h3>FIDO Key éŸ¿æ‡‰æ•¸æ“šï¼š</h3>
            <pre id="fidoKeyResponseData">
                æˆåŠŸéŸ¿æ‡‰å¾Œï¼ŒFIDO Key è¿”å›çš„æ•¸æ“šå°‡æœƒé¡¯ç¤ºåœ¨é€™è£¡ã€‚
            </pre>
            <div class="aaguid-info">
                <p><strong>é—œæ–¼å» å•†è³‡è¨Šï¼š</strong></p>
                <p>
                    åŸºæ–¼ WebAuthn çš„å®‰å…¨èˆ‡éš±ç§è¨­è¨ˆï¼Œç€è¦½å™¨å‰ç«¯ JavaScript ç„¡æ³•ç›´æ¥è®€å– FIDO Key çš„<strong>å» å•†åç¨±</strong>æˆ–<strong>å…·é«”å‹è™Ÿ</strong>ã€‚
                    ä½†éŸ¿æ‡‰æ•¸æ“šä¸­çš„ `authenticatorData` å¯èƒ½åŒ…å« **AAGUID (Authenticator Attestation GUID)**ï¼Œ
                    é€™æ˜¯ä¸€å€‹å”¯ä¸€çš„è­˜åˆ¥ç¢¼ï¼Œç”¨æ–¼å€åˆ†ä¸åŒçš„é©—è­‰å™¨æ¨¡å‹ã€‚
                </p>
                <p>
                    è‹¥è¦å°‡ AAGUID è½‰æ›ç‚ºå¯è®€çš„å» å•†è³‡è¨Šï¼Œé€šå¸¸éœ€è¦å°‡å…¶ç™¼é€åˆ°å¾Œç«¯ä¼ºæœå™¨ï¼Œ
                    ä¸¦åœ¨å¾Œç«¯æŸ¥è©¢ FIDO Alliance çš„å…ƒæ•¸æ“šæœå‹™æˆ–å…¶ä»–è³‡æ–™åº«ã€‚
                </p>
            </div>
        </div>
    </div>

    <script>
        const testButton = document.getElementById('testButton');
        const messageArea = document.getElementById('messageArea');
        const fidoKeyResponseData = document.getElementById('fidoKeyResponseData');
        const rpId = window.location.hostname; // ä½¿ç”¨ç•¶å‰é é¢çš„åŸŸåä½œç‚º Relying Party ID
        const userId = new Uint8Array(16); // éš¨æ©Ÿç”Ÿæˆä¸€å€‹ 16 ä½å…ƒçµ„çš„ä½¿ç”¨è€… ID
        const userName = `testuser_${Date.now()}`; // éš¨æ©Ÿç”Ÿæˆä¸€å€‹ä½¿ç”¨è€…åç¨±
        const userDisplayName = `æ¸¬è©¦ä½¿ç”¨è€… ${Date.now()}`; // éš¨æ©Ÿç”Ÿæˆä¸€å€‹é¡¯ç¤ºåç¨±

        // è¼”åŠ©å‡½æ•¸ï¼šå°‡ ArrayBuffer è½‰æ›ç‚º Uint8Array é™£åˆ—ï¼ˆæ–¹ä¾¿ JSON åºåˆ—åŒ–å’Œé¡¯ç¤ºï¼‰
        function arrayBufferToUint8ArrayArray(buffer) {
            if (!buffer) return null;
            return Array.from(new Uint8Array(buffer));
        }

        // è¼”åŠ©å‡½æ•¸ï¼šå°‡ ArrayBuffer è½‰æ›ç‚º Base64 URL å­—ä¸²ï¼ˆWebAuthn å¸¸ç”¨æ ¼å¼ï¼‰
        function arrayBufferToBase64Url(buffer) {
            if (!buffer) return null;
            const bytes = new Uint8Array(buffer);
            let binary = '';
            for (let i = 0; i < bytes.byteLength; i++) {
                binary += String.fromCharCode(bytes[i]);
            }
            return btoa(binary)
                .replace(/\+/g, '-')
                .replace(/\//g, '_')
                .replace(/=/g, '');
        }

        // è¼”åŠ©å‡½æ•¸ï¼šå¾ AuthenticatorData æå– AAGUID (å‰ 16 ä½å…ƒçµ„)
        // æ›´å¤šé—œæ–¼ authenticatorData çš„è§£æéœ€è¦ Cbor è§£ç¢¼ï¼Œé€™è£¡åƒ…æå–å‰ 16 ä½å…ƒçµ„
        function getAAGUIDFromAuthenticatorData(authenticatorDataBuffer) {
            if (!authenticatorDataBuffer || authenticatorDataBuffer.byteLength < 16) {
                return null;
            }
            const aaguidBytes = authenticatorDataBuffer.slice(0, 16);
            return arrayBufferToBase64Url(aaguidBytes);
        }

        // ç”Ÿæˆ WebAuthn æŒ‘æˆ° (éš¨æ©Ÿ 32 ä½å…ƒçµ„)
        function generateChallenge() {
            return window.crypto.getRandomValues(new Uint8Array(32)).buffer;
        }

        testButton.addEventListener('click', testFidoKey);

        async function testFidoKey() {
            testButton.disabled = true;
            messageArea.className = 'message-area info-message';
            messageArea.textContent = 'æ­£åœ¨æº–å‚™æ¸¬è©¦... è«‹æ³¨æ„ç€è¦½å™¨æç¤ºã€‚';
            fidoKeyResponseData.textContent = 'ç­‰å¾…æ‚¨çš„ FIDO Key éŸ¿æ‡‰...';

            // ç”Ÿæˆéš¨æ©Ÿä½¿ç”¨è€… ID
            window.crypto.getRandomValues(userId);
            const challenge = generateChallenge();

            const publicKeyCredentialCreationOptions = {
                challenge: challenge,
                rp: {
                    id: rpId, // ä¾è³´æ–¹ IDï¼Œé€šå¸¸æ˜¯æ‚¨çš„åŸŸå
                    name: "FIDO Key æ¸¬è©¦ç«™é»",
                },
                user: {
                    id: userId, // å¿…é ˆæ˜¯ Uint8Array æˆ– ArrayBuffer
                    name: userName,
                    displayName: userDisplayName,
                },
                pubKeyCredParams: [
                    { alg: -7, type: "public-key" }, // ES256
                    { alg: -257, type: "public-key" }, // RS256
                ],
                authenticatorSelection: {
                    authenticatorAttachment: "cross-platform", // å…è¨±å¤–éƒ¨ FIDO Key
                    userVerification: "preferred", // åå¥½ä½¿ç”¨è€…é©—è­‰ (PIN/æŒ‡ç´‹)
                    residentKey: "preferred", // åå¥½ resident key (Passkey)
                    requireResidentKey: false, // ä¸å¼·åˆ¶è¦æ±‚ Resident Key
                },
                timeout: 60000, // 60ç§’è¶…æ™‚
                attestation: "direct", // è«‹æ±‚ç›´æ¥èªè­‰è­‰æ˜çš„ attestation æ–¹å¼
            };

            try {
                // èª¿ç”¨ WebAuthn API å‰µå»ºæ†‘è­‰ (å³è¨»å†Š)
                const credential = await navigator.credentials.create({
                    publicKey: publicKeyCredentialCreationOptions,
                });

                // å¦‚æœæˆåŠŸï¼ŒFIDO Key æ­£å¸¸
                messageArea.className = 'message-area success-message';
                messageArea.textContent = 'ğŸ‰ æ‚¨çš„ FIDO Key æ­£å¸¸é‹ä½œï¼è«‹æŸ¥çœ‹ä¸‹æ–¹éŸ¿æ‡‰æ•¸æ“šã€‚';

                // æå–ä¸¦é¡¯ç¤ºéŸ¿æ‡‰æ•¸æ“š
                const responseData = {
                    id: credential.id,
                    rawId: arrayBufferToUint8ArrayArray(credential.rawId),
                    type: credential.type,
                    // response åŒ…å«å¯¦éš›çš„é©—è­‰å™¨æ•¸æ“šå’Œç°½å
                    response: {
                        clientDataJSON: arrayBufferToUint8ArrayArray(credential.response.clientDataJSON),
                        authenticatorData: arrayBufferToUint8ArrayArray(credential.response.authenticatorData),
                        signature: arrayBufferToUint8ArrayArray(credential.response.signature),
                        // è¨»å†Šæ™‚æœƒæœ‰ attestationObject
                        attestationObject: arrayBufferToUint8ArrayArray(credential.response.attestationObject),
                    },
                    // å°‡ Base64 URL ç·¨ç¢¼çš„ rawId ä¹Ÿé¡¯ç¤ºå‡ºä¾†ï¼Œæ–¹ä¾¿æª¢æŸ¥
                    rawIdBase64Url: arrayBufferToBase64Url(credential.rawId),
                    // é¡¯ç¤ºåŸå§‹æŒ‘æˆ° (ç‚ºäº†æª¢æŸ¥)
                    challengeUsed: arrayBufferToUint8ArrayArray(challenge),
                    // æ–°å¢ AAGUID è³‡è¨Š
                    detectedAAGUID: getAAGUIDFromAuthenticatorData(credential.response.authenticatorData)
                };

                fidoKeyResponseData.textContent = JSON.stringify(responseData, null, 2);

            } catch (error) {
                // FIDO Key ç•°å¸¸æˆ–ä½¿ç”¨è€…å–æ¶ˆ
                messageArea.className = 'message-area error-message';
                let errorMessageText = 'æ¸¬è©¦å¤±æ•—ã€‚';

                if (error.name === 'NotAllowedError') {
                    errorMessageText = 'æ‚¨å–æ¶ˆäº† FIDO Key äº’å‹•æˆ–æ¬Šé™è¢«æ‹’çµ•ã€‚';
                } else if (error.name === 'SecurityError') {
                    errorMessageText = 'å®‰å…¨æ€§éŒ¯èª¤ï¼šWebAuthn åªèƒ½åœ¨ HTTPS ç’°å¢ƒä¸‹é‹è¡Œ (æˆ– localhost)ã€‚';
                } else if (error.name === 'AbortError') {
                    errorMessageText = 'æ“ä½œè¢«ä¸­æ­¢ (å¯èƒ½å› é€¾æ™‚æˆ–ç€è¦½å™¨å•é¡Œ)ã€‚';
                }
                else if (error.message) {
                    errorMessageText += `éŒ¯èª¤è¨Šæ¯: ${error.message}`;
                }
                console.error("FIDO Key æ¸¬è©¦éŒ¯èª¤:", error);
                messageArea.textContent = errorMessageText;
                fidoKeyResponseData.textContent = `éŒ¯èª¤ï¼š${errorMessageText}\nè«‹æª¢æŸ¥æ‚¨çš„ FIDO Key æ˜¯å¦é€£æ¥æ­£å¸¸ï¼Œæˆ–ç€è¦½å™¨æ¬Šé™ã€‚`;
            } finally {
                testButton.disabled = false;
            }
        }

        // åˆå§‹æª¢æŸ¥ WebAuthn æ”¯æŒæ€§
        function initialCheck() {
            if (!window.PublicKeyCredential) {
                messageArea.textContent = 'æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æŒ WebAuthn APIã€‚è«‹ä½¿ç”¨ Chrome, Firefox, Edge, Safari ç­‰ç¾ä»£ç€è¦½å™¨ã€‚';
                messageArea.className = 'message-area error-message';
                testButton.disabled = true;
            } else if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                messageArea.textContent = 'å®‰å…¨æ€§è­¦å‘Šï¼šWebAuthn API åƒ…èƒ½åœ¨ HTTPS æˆ– localhost ç’°å¢ƒä¸‹é‹è¡Œã€‚è«‹ä½¿ç”¨æœ¬åœ°ä¼ºæœå™¨æˆ– HTTPS ç¶²ç«™ã€‚';
                messageArea.className = 'message-area error-message';
                testButton.disabled = true;
            } else {
                 messageArea.textContent = 'ç€è¦½å™¨æ”¯æŒ WebAuthnã€‚æº–å‚™å°±ç·’ï¼Œè«‹é»æ“Šã€Œæ¸¬è©¦æˆ‘çš„ FIDO Keyã€æŒ‰éˆ•ã€‚';
                 messageArea.className = 'message-area info-message';
            }
        }

        initialCheck();
    </script>
</body>
</html>